<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>유희왕 카드 관리</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { --primary-cyan: #009688; --dark-cyan: #00796b; --error-red: #f44336; --warning-yellow: #fbc02d; --success-green: #2e7d32; --disabled-grey: #bdbdbd; }
    body, input, button, table, .btn, .modal-content, select { font-family: 'Pretendard', sans-serif !important; }
    body { background-color: #f4f7f6; }
    /* 버전 표기 스타일 */
    .version-info { position: absolute; top: 8px; left: 12px; font-size: 0.75rem; color: #aaa; font-weight: 600; z-index: 10; }
    
    .container { margin-top: 30px; max-width: 95% !important; }
    .app-title { text-align: center; margin-bottom: 25px; font-weight: 800; color: #333; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; }
    .beta-tag { color: var(--error-red); font-size: 14px; margin-left: 6px; align-self: flex-start; margin-top: 10px; font-weight: 600; }
    .guide-trigger-wrapper { width: 100%; display: flex; justify-content: flex-end; margin-bottom: 8px; padding-right: 15px; }
    .guide-trigger-top { color: var(--dark-cyan); font-weight: 600; font-size: 0.95rem; cursor: pointer; border: none; background: none; display: flex; align-items: center; gap: 4px; }
    .search-box { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: flex; flex-direction: column; align-items: center; position: relative; }
    .search-row { display: flex; align-items: center; justify-content: center; width: 100%; }
    .search-ghost { width: 110px; flex-shrink: 0; } 
    .search-input-wrapper { flex: 0 1 600px; position: relative; }
    .btn-group { display: flex; align-items: center; gap: 8px; margin-left: 15px; width: 110px; flex-shrink: 0; }
    input#card-search { text-align: center !important; font-size: 1.2rem; padding-right: 40px !important; box-sizing: border-box; }
    .clear-search-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; color: #ccc; display: none; z-index: 5; }
    .btn.cyan-theme { background-color: var(--primary-cyan) !important; border-radius: 4px; font-weight: 600; }
    @media only screen and (max-width: 600px) { .search-box { padding: 20px 10px; } .search-ghost { display: none; } .search-input-wrapper { flex: 1; } .btn-group { width: auto; margin-left: 8px; } .modal { width: 95% !important; max-height: 90% !important; top: 5% !important; } }
    table { background: white; font-size: 0.85rem; table-layout: fixed; width: 100%; border-collapse: collapse; }
    th { background: var(--primary-cyan); color: white; text-align: center !important; border: 1px solid #ddd; padding: 8px 2px; font-size: 0.8rem; word-break: break-all; }
    td { border: 1px solid #ddd; text-align: center; padding: 8px 2px; position: relative; word-break: break-all; }
    .col-card-no { width: 180px; } .col-loc { width: 110px; } .col-total { width: 60px; } .col-proc { width: 70px; } 
    .expand-btn { cursor: pointer; color: var(--primary-cyan); position: absolute; right: 4px; top: 50%; transform: translateY(-50%); font-size: 1.3rem; }
    .another-row { background-color: #fafafa !important; display: none; }
    .another-val { text-align: center !important; font-weight: 500; color: #444; }
    .sub-row { width: 100%; max-width: 800px; display: flex; justify-content: space-between; align-items: center; margin-top: 15px; min-height: 40px; }
    .recent-searches { font-size: 0.9rem; color: #666; display: flex; gap: 10px; align-items: center; }
    .recent-item { cursor: pointer; color: var(--primary-cyan); text-decoration: underline; font-weight: 500; }
    .modal { border-radius: 12px; width: 95% !important; max-width: 600px !important; }
    .url-input-container { position: relative; display: flex; align-items: center; margin-top: 20px; margin-bottom: 5px; }
    .url-input-container input { margin-bottom: 0 !important; padding-right: 40px !important; }
    .valid-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); display: none; }
    .status-msg { font-size: 0.85rem; font-weight: 600; margin-bottom: 20px; min-height: 1.2rem; }
    .guide-btn { cursor: pointer; color: var(--dark-cyan); font-size: 1rem; font-weight: 700; margin-bottom: 12px; display: flex; align-items: center; gap: 4px; }
    .guide-btn i { transition: transform 0.2s ease; }
    .guide-btn.active i { transform: rotate(90deg); }
    .guide-content { background: #f1f8f7; padding: 18px; border-radius: 8px; font-size: 0.95rem; border: 1px solid #d1e4e1; display: none; margin-bottom: 15px; }
    .btn.disabled, .btn:disabled { background-color: var(--disabled-grey) !important; color: #fff !important; pointer-events: none; }
    #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.85); z-index: 11000; flex-direction: column; align-items: center; justify-content: center; }
    #result-area { overflow-x: auto; max-height: 0; opacity: 0; transition: max-height 0.6s ease; width: 100%; }
    #result-area.show { max-height: 10000px; opacity: 1; }

    /* FAB 설정 */
    .fixed-action-btn { bottom: 24px; right: 24px; }
    .fixed-action-btn .main-fab i { transition: transform 0.3s ease; }
    
    /* ★ FAB 커스텀 상태 (.fab-open) 제어 
       라이브러리의 .active 대신 우리가 JS로 붙이는 .fab-open 클래스를 기준으로 작동 
    */
    .fixed-action-btn.fab-open .main-fab i { transform: rotate(45deg); }
    
    /* 하위 버튼 목록 레이아웃 */
    .fixed-action-btn ul li { 
      margin-bottom: 12px; 
      text-align: right; 
      position: relative; 
    }
    
    /* FAB 레이블 설정 */
    .fab-label { 
      position: absolute;
      right: 52px; 
      top: 50%;
      transform: translateY(-50%);
      
      background: #757575; 
      color: white; 
      padding: 6px 12px; 
      border-radius: 4px;
      font-size: 0.85rem; 
      white-space: nowrap; 
      pointer-events: none;
      font-weight: 500;
      line-height: 1.2;
      
      /* 기본(닫힘): 투명, 즉시 반응 (딜레이 없음) */
      opacity: 0; 
      transition: opacity 0.2s ease 0s; 
    }
    
    /* FAB 열림 상태: 딜레이 0.1초로 단축하여 빠르게 등장 */
    .fixed-action-btn.fab-open .fab-label { 
      opacity: 1; 
      transition: opacity 0.3s ease 0.1s; 
    }

    #add-card-modal, #manage-card-modal, #discard-card-modal { width: 95% !important; max-width: 1100px !important; }
    .modal-subtitle { color: #666; font-size: 0.95rem; margin-top: -15px; margin-bottom: 20px; display: block; }
    .add-modal-table { font-size: 0.82rem; width: 100%; border-collapse: collapse; }
    .add-modal-table th { background: #f5f5f5; color: #666; font-weight: 700; padding: 10px 4px; text-align: center; border: 1px solid #ddd; }
    .add-modal-table td { padding: 6px 4px; border: 1px solid #ddd; }
    .td-flex-container { display: flex; align-items: center; gap: 4px; width: 100%; height: 100%; }
    .flex-select { flex: 1; min-width: 0; height: 2.2rem !important; font-size: 0.85rem; }
    .flex-input { flex: 1; min-width: 0; height: 2.2rem !important; display: none; border: 1px solid #ccc !important; padding: 0 5px !important; box-sizing: border-box !important; }
    .card-name-fetch { color: var(--dark-cyan); font-weight: 700; font-size: 0.8rem; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; text-align: center; }
  </style>
</head>
<body>

<div class="version-info">ver. 0.1.18</div>
<div id="center-overlay"></div>
<div id="loading-overlay">
  <div class="preloader-wrapper big active"><div class="spinner-layer spinner-teal-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div></div>
  <p id="loading-text" style="margin-top: 20px; font-weight: bold; color: var(--dark-cyan);">데이터 로드 중...</p>
</div>

<div class="container">
  <h4 class="app-title">유희왕 카드 관리 <span class="beta-tag">Beta</span></h4>
  <div class="guide-trigger-wrapper"><button class="guide-trigger-top" onclick="openGuideFromMain()"><i class="material-icons">help_outline</i> 사용법</button></div>
  <div class="search-box">
    <div class="search-row"><div class="search-ghost"></div><div class="search-input-wrapper"><div class="input-field"><input type="text" id="card-search" class="autocomplete" autocomplete="off" placeholder="카드 이름을 입력하세요"><i id="clear-btn" class="material-icons clear-search-btn">cancel</i></div></div><div class="btn-group"><button id="search-btn" class="btn waves-effect waves-light cyan-theme" onclick="startSearch()" style="height: 45px;"><i class="material-icons">search</i></button><button class="btn grey darken-1 modal-trigger tooltipped" data-position="bottom" data-tooltip="시트 설정" href="#settings-modal" onclick="toggleGuide(false)" style="height: 45px; padding: 0 10px;"><i class="material-icons">settings</i></button></div></div>
    <div class="sub-row"><div id="recent-search-area" class="recent-searches">최근 검색 : </div><i id="clear-history-icon" class="material-icons clear-history-btn tooltipped" data-position="bottom" data-tooltip="기록 삭제" onclick="clearAllHistory()">delete_sweep</i></div>
  </div>
  <div class="result-container"><div id="result-area"></div></div>
</div>

<div id="fab-menu" class="fixed-action-btn">
  <a class="btn-floating btn-large cyan-theme main-fab"><i id="fab-icon" class="large material-icons">add</i></a>
  <ul>
    <li><a class="btn-floating grey darken-1" onclick="checkAuthAndOpen('#add-card-modal')"><i class="material-icons">library_add</i></a><span class="fab-label">카드 추가</span></li>
    <li><a class="btn-floating grey darken-1" onclick="checkAuthAndOpen('#manage-card-modal')"><i class="material-icons">import_export</i></a><span class="fab-label">카드 관리</span></li>
    <li><a class="btn-floating grey darken-1" onclick="checkAuthAndOpen('#discard-card-modal')"><i class="material-icons">delete_outline</i></a><span class="fab-label">카드 폐기</span></li>
  </ul>
</div>

<div id="manage-card-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-weight: 800; margin-bottom: 10px;">카드 관리</h5>
    <span class="modal-subtitle">카드의 보관 장소를 변경할 수 있습니다.</span>
    <div style="overflow-x: auto;">
      <table class="add-modal-table">
        <thead>
          <tr>
            <th style="width: 22%;">카드 이름</th><th style="width: 15%;">카드 번호</th><th style="width: 13%;">가공</th><th style="width: 12%;">어나더</th>
            <th style="width: 13%;">보관 장소</th><th style="width: 15%;">이동 장소</th><th style="width: 10%;">이동 수량</th>
          </tr>
        </thead>
        <tbody id="manage-card-tbody"></tbody>
      </table>
    </div>
    <div style="margin-top: 20px; text-align: center;"><button class="btn-flat waves-effect" onclick="addManageRows()" style="color: var(--primary-cyan); font-weight: 700;">더 많은 카드를 이동하시나요?</button></div>
  </div>
  <div class="modal-footer"><button class="btn-flat modal-close">취소</button><button class="btn cyan-theme" onclick="M.Modal.getInstance(document.getElementById('manage-card-modal')).close()">이동</button></div>
</div>

<div id="discard-card-modal" class="modal">
  <div class="modal-content"><h5 style="font-weight: 800; margin-bottom: 20px;">카드 폐기</h5><p class="center" style="color: #9e9e9e; margin-top: 50px;">서비스 준비 중입니다.</p></div>
  <div class="modal-footer"><button class="btn-flat modal-close">닫기</button></div>
</div>

<div id="settings-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-weight: 800; margin-bottom: 10px;">사용법 및 연결</h5>
    <p style="color: #555; line-height: 1.5; margin-bottom: 20px;">이 앱은 구글 시트를 기반으로 사용자가 보유한 카드를 등록하여, 실물 카드 관리를 보조합니다.<br>양식에 맞는 구글 시트 링크를 입력해주세요.</p>
    <div class="guide-btn" id="guide-accordion-btn" onclick="toggleGuide()"><i class="material-icons">keyboard_arrow_right</i><span>양식 다운로드 및 사용법</span></div>
    <div id="guide-box" class="guide-content"><ol><li><a href="https://docs.google.com/spreadsheets/d/16AVBIJvass2Zl6f4IwMpK5KcZkPOuGATWfo0FIdeOdw/copy" target="_blank" style="color: var(--primary-cyan); font-weight: 800; text-decoration: underline;">링크</a>를 눌러 양식 시트를 구글 드라이브에 복사합니다.</li><li>해당 파일을 **링크가 있는 모든 사용자 / 편집자**로 공유 설정을 변경합니다.</li><li>해당 파일의 공유 링크를 입력 후 확인을 눌러주세요.</li></ol></div>
    <div class="url-input-container"><input type="text" id="sheet-url" placeholder="https://docs.google.com/spreadsheets/d/..." oninput="validateSheetLink()"><div id="valid-mark" class="valid-icon"></div></div>
    <div id="status-msg" class="status-msg"></div>
  </div>
  <div class="modal-footer" style="display: flex; justify-content: space-between; padding: 0 24px 20px 24px; align-items: center; height: auto;">
    <button id="disconnect-btn" class="btn red darken-1 waves-effect waves-light" onclick="disconnectSheet()">연결 끊기</button>
    <div><button class="btn-flat modal-close">취소</button><button id="confirm-btn" class="btn cyan-theme waves-effect waves-light disabled" onclick="saveSettings()">확인</button></div>
  </div>
</div>

<div id="add-card-modal" class="modal">
  <div class="modal-content">
    <h5 style="font-weight: 800; margin-bottom: 10px;">카드 추가</h5>
    <span class="modal-subtitle">원하는 카드를 추가할 수 있습니다.</span>
    <div style="overflow-x: auto;">
      <table class="add-modal-table">
        <thead><tr><th style="width: 25%;">카드 이름</th><th style="width: 18%;">카드 번호</th><th style="width: 17%;">가공</th><th style="width: 10%;">수량</th><th style="width: 17%;">보관 장소</th><th style="width: 13%;">어나더</th></tr></thead>
        <tbody id="add-card-tbody"></tbody>
      </table>
    </div>
    <div style="margin-top: 20px; text-align: center;"><button class="btn-flat waves-effect" onclick="addMoreRows()" style="color: var(--primary-cyan); font-weight: 700;">더 많은 카드를 등록할 건가요?</button></div>
  </div>
  <div class="modal-footer"><button class="btn-flat modal-close">취소</button><button id="add-submit-btn" class="btn cyan-theme" onclick="submitNewCards()">추가</button></div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwgOQN7QaR9vqUb0xmmeygmhIxuX6Th2LqZZ0kDmIKFa9RrR3zYBrFxVpdJRa9nXkYC/exec";
  const STORAGE_KEY = 'yugioh_spreadsheet_id';
  const RECENT_KEY = 'recent_card_searches';

  let allProcessingTypes = [], allNames = [], allLocations = [], localCardDatabase = [];
  let isAppConfigured = false, acInstance = null, isLoading = false, validationTimeout = null;

  // ★ 1. FAB 상태 관리 변수
  let isFabOpen = false;

  document.addEventListener('DOMContentLoaded', function() {
    M.Modal.init(document.querySelectorAll('.modal'));
    M.Tooltip.init(document.querySelectorAll('.tooltipped'));
    const fabElem = document.getElementById('fab-menu');
    const fabIcon = document.getElementById('fab-icon');
    
    // ★ 2. 메인 FAB 버튼 클릭 이벤트 리스너 (즉시 반응 로직)
    const mainFabBtn = fabElem.querySelector('.main-fab');
    mainFabBtn.addEventListener('click', function() {
      // 클릭 시 상태 토글
      isFabOpen = !isFabOpen;
      updateFabState(fabElem);
    });

    // ★ 3. Materialize FAB 초기화 및 동기화 (외부 클릭 방어)
    M.FloatingActionButton.init(fabElem, {
      direction: 'top',
      hoverEnabled: false,
      onCloseStart: () => {
        // 사용자가 배경을 클릭하여 닫을 경우를 대비한 동기화
        if(isFabOpen) {
            isFabOpen = false;
            updateFabState(fabElem);
        }
      }
    });
    
    const searchInput = document.getElementById('card-search');
    searchInput.addEventListener('keydown', function(e) { if (e.key === 'Enter') { const dropdown = document.querySelector('.autocomplete-content'); if (dropdown) { const firstVisible = dropdown.querySelector('li:not(.hide)'); if (firstVisible) this.value = firstVisible.innerText.trim(); } if (acInstance) acInstance.close(); this.blur(); startSearch(); } });
    updateDisconnectBtn(); renderRecentSearches(); refreshInitialData();
  });

  // ★ 4. FAB 상태 업데이트 함수
  function updateFabState(fabElem) {
    if (isFabOpen) {
      fabElem.classList.add('fab-open');
    } else {
      fabElem.classList.remove('fab-open');
    }
  }

  async function callApi(action, params = {}, postData = null) {
    const url = new URL(SCRIPT_URL); url.searchParams.append("action", action);
    const savedId = localStorage.getItem(STORAGE_KEY); if (savedId) url.searchParams.append("ssId", savedId);
    for (const key in params) { url.searchParams.append(key, params[key]); }
    const options = { method: postData ? 'POST' : 'GET' }; if (postData) options.body = JSON.stringify(postData);
    const response = await fetch(url, options); return await response.json();
  }

  function checkAuthAndOpen(modalId) {
    if (!localStorage.getItem(STORAGE_KEY)) { M.toast({html: '먼저 구글 시트를 연결해주세요!', classes: 'red darken-2 rounded'}); return; }
    if (modalId === '#manage-card-modal' && document.getElementById('manage-card-tbody').children.length === 0) addManageRows(1);
    if (modalId === '#add-card-modal' && document.getElementById('add-card-tbody').children.length === 0) addMoreRows(1);
    M.Modal.getInstance(document.querySelector(modalId)).open();
  }

  function validateSheetLink() {
    clearTimeout(validationTimeout); const url = document.getElementById('sheet-url').value.trim();
    const mark = document.getElementById('valid-mark'), msg = document.getElementById('status-msg'), confirmBtn = document.getElementById('confirm-btn');
    if (!url) { mark.style.display = 'none'; msg.innerText = ''; confirmBtn.classList.add('disabled'); return; }
    const match = url.match(/[-\w]{25,}/);
    if (!match) { mark.innerHTML = '<i class="material-icons" style="color: var(--error-red)">cancel</i>'; mark.style.display = 'block'; msg.innerText = '구글 시트 링크를 적어주세요.'; msg.style.color = 'var(--error-red)'; confirmBtn.classList.add('disabled'); return; }
    validationTimeout = setTimeout(async () => {
      msg.innerText = '권한 확인 중...'; try {
        const res = await callApi('checkSheet', { targetId: match[0] });
        if (res.status === 'OK') { mark.innerHTML = '<i class="material-icons" style="color: var(--success-green)">check_circle</i>'; msg.innerText = '유효한 시트입니다.'; msg.style.color = 'var(--success-green)'; confirmBtn.classList.remove('disabled'); } 
        else { mark.innerHTML = '<i class="material-icons" style="color: var(--warning-yellow)">warning</i>'; msg.innerText = (res.status === 'NO_EDIT_ACCESS') ? '공유 설정을 링크를 가진 모든 사용자 / 편집자로 설정해주세요.' : '접근할 수 없거나 형식이 잘못되었습니다.'; msg.style.color = 'var(--warning-yellow)'; confirmBtn.classList.add('disabled'); }
        mark.style.display = 'block';
      } catch (e) { msg.innerText = '확인 실패'; }
    }, 500);
  }

  async function refreshInitialData() {
    const savedId = localStorage.getItem(STORAGE_KEY); if (!savedId) return;
    showLoading(true, "데이터 동기화 중...");
    try {
      const res = await callApi('getInitialData');
      showLoading(false); isAppConfigured = res.isConfigured;
      if (res.isConfigured) { allNames = res.names; allProcessingTypes = res.processingTypes; allLocations = res.locations; localCardDatabase = res.allCards; setupAutocomplete(); }
    } catch (e) { showLoading(false); }
  }

  function setupAutocomplete() {
    const searchInput = document.getElementById('card-search');
    const fullData = {}; allNames.forEach(name => fullData[name] = null);
    acInstance = M.Autocomplete.init(searchInput, { data: fullData, onAutocomplete: startSearch, limit: 15, minLength: 1 });
  }

  // 카드 관리 모달 로직 (추천 검색어 제거 및 대조 로직 적용)
  function addManageRows(count = null) {
    const tbody = document.getElementById('manage-card-tbody');
    const increment = count || (tbody.children.length === 1 ? 4 : 5);
    for (let i = 0; i < increment; i++) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><span class="card-name-fetch">번호 입력 대기</span></td>
        <td><input type="text" class="manage-card-no" onblur="updateManageDropdowns(this)" placeholder="번호 입력"></td>
        <td><select class="browser-default manage-proc flex-select" disabled><option value="">선택</option></select></td>
        <td><select class="browser-default manage-another flex-select" disabled><option value="">-</option></select></td>
        <td><select class="browser-default manage-loc flex-select" disabled><option value="">선택</option></select></td>
        <td><div class="td-flex-container"><select class="browser-default move-loc flex-select" onchange="syncDirectInput(this)"><option value="" disabled selected>선택</option>${allLocations.map(l => `<option value="${l}">${l}</option>`).join('')}<option value="DIRECT">직접 입력</option></select><input type="text" class="direct-input loc-direct flex-input" placeholder="새로운 위치"></div></td>
        <td><input type="number" class="move-qty" min="1" style="height:2.2rem !important; text-align:center;"></td>
      `;
      tbody.appendChild(row);
    }
  }

  function updateManageDropdowns(inputEl) {
    const row = inputEl.closest('tr');
    const cardNo = inputEl.value.trim().toUpperCase();
    inputEl.value = cardNo; // 소문자 입력 시 시각적으로 즉시 대문자로 변경
    const nameSpan = row.querySelector('.card-name-fetch');
    const procSel = row.querySelector('.manage-proc');
    const anotherSel = row.querySelector('.manage-another');
    const locSel = row.querySelector('.manage-loc');

    if (!cardNo) { nameSpan.innerText = "번호 입력 대기"; return; }

    const matches = localCardDatabase.filter(r => String(r[1]).toUpperCase() === cardNo);
    if (matches.length > 0) {
      nameSpan.innerText = matches[0][0];
      const rarities = [...new Set(matches.map(r => r[2]))];
      const anothers = [...new Set(matches.map(r => r[5] || ""))];
      const locs = [...new Set(matches.map(r => r[4]))];

      procSel.innerHTML = rarities.map(r => `<option value="${r}">${r}</option>`).join(''); procSel.disabled = false;
      anotherSel.innerHTML = (anothers.includes("") ? `<option value="">기본</option>` : '') + anothers.filter(a => a !== "").map(a => `<option value="${a}">${a}</option>`).join('');
      anotherSel.disabled = anothers.length === 1 && anothers[0] === "";
      locSel.innerHTML = locs.map(l => `<option value="${l}">${l}</option>`).join(''); locSel.disabled = false;
    } else {
      nameSpan.innerText = "보유하지 않은 카드"; procSel.disabled = true; anotherSel.disabled = true; locSel.disabled = true;
    }
  }

  async function submitNewCards() {
    const tbody = document.getElementById('add-card-tbody'); const rows = [];
    for (let tr of tbody.children) {
      const cardNo = tr.querySelector('.new-card-no').value.trim(); const name = tr.querySelector('.card-name-fetch').innerText;
      if (!cardNo || name === "결과 없음" || name === "조회 중..." || name === "번호 입력 대기") continue;
      let proc = tr.querySelector('.new-card-proc').value === 'DIRECT' ? tr.querySelector('.rarity-direct').value.trim() : tr.querySelector('.new-card-proc').value;
      let loc = tr.querySelector('.new-card-loc').value === 'DIRECT' ? tr.querySelector('.loc-direct').value.trim() : tr.querySelector('.new-card-loc').value;
      const qty = tr.querySelector('.new-card-qty').value; const another = tr.querySelector('.new-card-another').value.trim();
      if (proc && loc && qty) rows.push([name, cardNo, proc, qty, loc, another]);
    }
    if (rows.length === 0) return;
    const btn = document.getElementById('add-submit-btn'); btn.classList.add('disabled');
    showLoading(true, "기록 중...");
    try {
      await callApi('addCards', {}, rows); M.Modal.getInstance(document.getElementById('add-card-modal')).close(); showLoading(false);
      M.toast({html: '카드 추가가 완료됐습니다!', displayLength: 1000, classes: 'cyan darken-2'}); setTimeout(() => location.reload(), 1000);
    } catch (e) { showLoading(false); btn.classList.remove('disabled'); }
  }

  function renderTable(rows) {
    showLoading(false); const resultArea = document.getElementById('result-area');
    if (rows.length === 0) { resultArea.innerHTML = "<p class='center'>결과 없음</p>"; resultArea.classList.add('show'); return; }
    const groups = {};
    rows.forEach(r => {
      const cardNo = String(r[1]), proc = String(r[2]), qty = parseInt(r[3]) || 0, loc = String(r[4]), another = String(r[5] || "").trim();
      if (!groups[cardNo]) groups[cardNo] = { locations: {}, anotherGroups: {} };
      if (!groups[cardNo].locations[loc]) groups[cardNo].locations[loc] = { total: 0, procs: {} };
      groups[cardNo].locations[loc].total += qty; groups[cardNo].locations[loc].procs[proc] = (groups[cardNo].locations[loc].procs[proc] || 0) + qty;
      if (another) {
        const aKey = `${another}|${loc}`; if (!groups[cardNo].anotherGroups[aKey]) groups[cardNo].anotherGroups[aKey] = { another, loc, total: 0, procs: {} };
        groups[cardNo].anotherGroups[aKey].total += qty; groups[cardNo].anotherGroups[aKey].procs[proc] = (groups[cardNo].anotherGroups[aKey].procs[proc] || 0) + qty;
      }
    });
    const activeProcs = allProcessingTypes.filter(pt => rows.some(r => String(r[2]).trim() === pt));
    let html = `<table><colgroup><col class="col-card-no"><col class="col-loc"><col class="col-total">`; activeProcs.forEach(() => html += `<col class="col-proc">`);
    html += `</colgroup><thead><tr><th>번호</th><th>장소</th><th>총합</th>`; activeProcs.forEach(pt => html += `<th>${pt}</th>`); html += `</tr></thead><tbody>`;
    Object.keys(groups).forEach(cardNo => {
      const g = groups[cardNo]; const locList = Object.keys(g.locations); const rowId = `row-${cardNo}`.replace(/[^a-zA-Z0-9]/g, '');
      locList.forEach((loc, idx) => {
        const item = g.locations[loc]; html += `<tr class="main-row card-${rowId}" data-loc="${loc}">`;
        if (idx === 0) html += `<td rowspan="${locList.length}">${cardNo}${Object.keys(g.anotherGroups).length > 0 ? `<i class="material-icons expand-btn" onclick="toggleAnother('${rowId}')">add_circle_outline</i>` : ''}</td>`;
        html += `<td class="main-loc-cell">${loc}</td><td class="main-total-cell" data-original="${item.total}">${item.total}</td>`;
        activeProcs.forEach(pt => { const v = item.procs[pt] || 0; html += `<td class="main-proc-cell" data-proc="${pt}" data-original="${v}">${v}</td>`; }); html += `</tr>`;
      });
      Object.values(g.anotherGroups).forEach(ag => { html += `<tr class="another-row ${rowId}-sub" data-another-loc="${ag.loc}" style="display:none;"><td class="another-val">↳ ${ag.another}</td><td>${ag.loc}</td><td>${ag.total}</td>`; activeProcs.forEach(pt => { html += `<td>${ag.procs[pt] || 0}</td>`; }); html += `</tr>`; });
    });
    resultArea.innerHTML = html + `</tbody></table>`; setTimeout(() => resultArea.classList.add('show'), 50);
  }

  function toggleAnother(rowId) {
    const subs = Array.from(document.getElementsByClassName(rowId + '-sub')); const mains = Array.from(document.getElementsByClassName('card-' + rowId));
    const isExpanding = subs[0].style.display === 'none'; subs.forEach(s => s.style.display = isExpanding ? 'table-row' : 'none');
    event.target.innerText = isExpanding ? 'remove_circle_outline' : 'add_circle_outline';
    mains.forEach(mRow => {
      const loc = mRow.getAttribute('data-loc'); const totalCell = mRow.querySelector('.main-total-cell'); const procCells = mRow.querySelectorAll('.main-proc-cell');
      let subT = 0, subP = {};
      subs.forEach(sRow => { if (sRow.getAttribute('data-another-loc') === loc) { subT += parseInt(sRow.cells[2].innerText) || 0; Array.from(sRow.cells).slice(3).forEach((c, i) => { const pN = procCells[i].getAttribute('data-proc'); subP[pN] = (subP[pN] || 0) + (parseInt(c.innerText) || 0); }); } });
      if (isExpanding) { totalCell.innerText = parseInt(totalCell.getAttribute('data-original')) - subT; procCells.forEach(pC => { const pN = pC.getAttribute('data-proc'); pC.innerText = parseInt(pC.getAttribute('data-original')) - (subP[pN] || 0); }); } 
      else { totalCell.innerText = totalCell.getAttribute('data-original'); procCells.forEach(pC => pC.innerText = pC.getAttribute('data-original')); }
    });
  }

  function addMoreRows(count = null) {
    const tbody = document.getElementById('add-card-tbody'); const increment = count || (tbody.children.length === 1 ? 4 : 5);
    for (let i = 0; i < increment; i++) {
      const row = document.createElement('tr');
      row.innerHTML = `<td><span class="card-name-fetch">번호 입력 대기</span></td><td><input type="text" class="new-card-no" onblur="fetchCardName(this)" placeholder="번호 입력"></td><td><div class="td-flex-container"><select class="browser-default new-card-proc flex-select" onchange="syncDirectInput(this)"><option value="" disabled selected>선택</option>${allProcessingTypes.map(p => `<option value="${p}">${p}</option>`).join('')}<option value="DIRECT">직접 추가</option></select><input type="text" class="direct-input rarity-direct flex-input" disabled></div></td><td><input type="number" class="new-card-qty" min="1" value="1" style="height:2.2rem !important; text-align:center;"></td><td><div class="td-flex-container"><select class="browser-default new-card-loc flex-select" onchange="syncDirectInput(this)"><option value="" disabled selected>선택</option>${allLocations.map(l => `<option value="${l}">${l}</option>`).join('')}<option value="DIRECT">직접 추가</option></select><input type="text" class="direct-input loc-direct flex-input" disabled></div></td><td><div class="td-flex-container" style="justify-content: center;"><label class="checkbox-label"><input type="checkbox" class="filled-in" onchange="syncAnother(this)"><span></span></label><input type="text" class="another-input new-card-another" disabled placeholder="원본"></div></td>`;
      tbody.appendChild(row);
    }
  }

  function syncDirectInput(sel) { const input = sel.nextElementSibling; if (sel.value === 'DIRECT') { sel.style.flex = "0 0 35%"; input.style.display = 'block'; input.style.flex = "1"; input.disabled = false; input.value = ""; input.focus(); } else { sel.style.flex = "1"; input.style.display = 'none'; input.disabled = true; input.value = sel.value; } }
  function syncAnother(cb) { const input = cb.closest('.td-flex-container').querySelector('.new-card-another'); if (cb.checked) { input.disabled = false; input.placeholder = "종류 입력"; input.focus(); } else { input.value = ""; input.disabled = true; input.placeholder = "원본"; } }
  function updateDisconnectBtn() { const btn = document.getElementById('disconnect-btn'); if (localStorage.getItem(STORAGE_KEY)) btn.classList.remove('disabled'); else btn.classList.add('disabled'); }
  function toggleGuide(forceOpen = null) { const btn = document.getElementById('guide-accordion-btn'); const box = document.getElementById('guide-box'); const isOpen = (forceOpen !== null) ? forceOpen : box.style.display === 'none'; box.style.display = isOpen ? 'block' : 'none'; if (isOpen) btn.classList.add('active'); else btn.classList.remove('active'); }
  function openGuideFromMain() { M.Modal.getInstance(document.getElementById('settings-modal')).open(); toggleGuide(true); }
  async function fetchCardName(el) { const cardNo = el.value.trim(); if (!cardNo) return; const nameSpan = el.closest('tr').querySelector('.card-name-fetch'); nameSpan.innerText = "조회 중..."; try { const res = await callApi('getCardNameFromDb', { cardNo }); nameSpan.innerText = res.name; } catch (e) { nameSpan.innerText = "조회 실패"; } }
  function startSearch() { const name = document.getElementById('card-search').value; if(!name || !isAppConfigured) return; saveRecentSearch(name); const filteredRows = localCardDatabase.filter(row => String(row[0]) === name); renderTable(filteredRows); }
  function saveSettings() { const url = document.getElementById('sheet-url').value; const match = url.match(/[-\w]{25,}/); if (match) { localStorage.setItem(STORAGE_KEY, match[0]); location.reload(); } }
  function disconnectSheet() { localStorage.removeItem(STORAGE_KEY); location.reload(); }
  function renderRecentSearches() { const recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); const area = document.getElementById('recent-search-area'); area.innerHTML = `최근 검색 : ` + recent.map(n => `<span class="recent-item" onclick="quickSearch('${n}')">${n}</span>`).join(' '); }
  function saveRecentSearch(name) { let recent = JSON.parse(localStorage.getItem(RECENT_KEY) || '[]'); recent = [name, ...recent.filter(n => n !== name)].slice(0, 5); localStorage.setItem(RECENT_KEY, JSON.stringify(recent)); renderRecentSearches(); }
  function clearAllHistory() { localStorage.removeItem(RECENT_KEY); renderRecentSearches(); }
  function quickSearch(name) { document.getElementById('card-search').value = name; startSearch(); }
  function showLoading(show, text) { isLoading = show; document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; document.getElementById('loading-text').innerText = text; }
</script>
</body>
</html>
